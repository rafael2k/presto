<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"/>
  <title>display module documentation</title>
</head>
<body>
    <h1>display module documentation</h1>
    <ul>
        <li><a href="api/index.html">API documentation generated by doxygen</a></li>
    </ul>
    <address>
        $Id$
    </address>

    <h2>The Text Shaper</h2>
    <p>
    The display module provides support for internal text
    shaping. Text shaping is used on arabic text - which has a cursive
    nature - in order to make characters look connected. This is
    achieved by replacing characters in the arabic unicode block with
    their initial, medial, isolated and final forms in the arabic
    presentation block. The text shaper also applies ligatures to
    combinations of arabic characters where a compound character
    exists that represents the combination.
    </p>
    <p>
    Apart from arabic text, Opera's internal text shaper is used to
    swap the devanagari (dependent) vowel sign i and the syllable it
    changes. This has nothing to do with text shaping per se, and is
    done for practical reasons only, the reason being that the
    devanagari (dependent) vowel sign i is the only (dependent) vowel
    sign (in the devanagari range) that is drawn to the left of the
    syllable it changes.
    </p>
    <p>
    The text shaper is active whenever the feature
    FEATURE_INTERNAL_TEXTSHAPER is set, and the API
    API_DISPLAY_TEXTSHAPER is imported.
    </p>
    <p>
    Prior to being moved to display, the text shaper resided in
    docutil. There has also been some
    changes in how the text shaper works in relation to the text
    shaper in docutil. Key points are:
    </p>
    <ul>
    <li>Text shaping is done in logical order (as opposed to reversed).
    <li>Text shaping is applied in TransformText (as opposed to
    GetStringWidth and DrawString).
    <li>Text shaping can be done one
    (resulting) character at a time, so that font switching can be
    applied to shaped text.
    </ul>

    <h3>Important functions</h3>
    <ul>
    <li>NeedsTransformation - determines if a string need be passed
    through the text shaper.
    <li>Prepare - replaces arabic characters with their presentation
    forms and applies ligatures. Also swaps devanagari (dependent)
    vowel sign i and the syllable it modifies.
    <li>GetShapedChar - returns one shaped character. (Don't forget to
    call ResetState before processing a string this way!)
    <li>ResetState - resets the text shaper's internal joining state.
    </ul>

    <h3>Memory usage</h3>
    <h4>OOM</h4>
    <p>
    The only function in the text shaper that can run out of memory is
    Prepare, in which case it will return the corresponding
    OP_STATUS. Thus, reporting OOM is left to the caller.
    </p>

    <h4>Stack memory</h4>
    <p>
    The TextShaper class uses some const arrays on the stack to store
    various attributes of arabic characters, as well as some other
    information. The current stack arrays exist:
    </p>
    <ul>
    <li>ligaturetable - 33 uni_chars, used to decide if a character
    sequence should be replaced with a ligature.
    <li>prestable_start - 180 uni_chars, used to map arabic
    characters to their first presentation form.
    <li>prestable_count - 180 UINT8s, used to determine how many
    presentation forms each arabic character has.
    <li>joinclasstable - 299 enums, used to determine which type of
    joining each arabic and syraic character has.
    </ul>

    <h4>Heap memory</h4>
    <p>
    The text shaper stores a TempBuffer in the DisplayModule
    object. This TempBuffer is set to hold the length of the input string
    whenever Prepare is called. Thus, the size of the TempBuffer
    depends on the input data. The minimum size of the TempBuffer is
    30 uni_chars. Since the DisplayModule object holds the TempBuffer,
    it is also responsible for cleanup.
    </p>

</body>
</html>
