<html>
<head>
<title>Documentation for the logdoc module</title>
<link rel="stylesheet" type="text/css" href="doc.css" />
</head>

<body>

<h1>Documentation for the logdoc module</h1>

This document documents the Logical Document module.

<div class="section">
<h2>Contents</h2>

<ol>
  <li>General Description</li>
  <li>API Overview</li>
  <li>API Details (Doxygen)</li>
  <li>Memory Issues</li>
  <li>Design Issues</li>
  <li>Special topics</li>
</ol>
</div>

<div class="section">
<h2>General Description</h2>

<p>The <em>logdoc</em> contains all code and datastructures of the <em>logical document</em> used in Opera. The logical document is the representation of the markup and data contained in the documents loaded.</p>

<p>The main data structure in the logical document is the <em>document tree</em> which is a tree structure made up of HTML_Element objects which represents the elements in the markup.</p>

<p><em>logdoc</em> is supposed to support all web standards usable in documents loaded from the web.</p>
</div>

<div class="section">
<h2>API Overview</h2>

<p>The <em>logdoc</em> module "exports" functionality in the following categories:</p>

<ul>
  <li>
    Initialization
    <ul>
      <li>LogdocModule</li>
    </ul>
  </li>
  <li>
    Manipulating the logical document
    <ul>
      <li>HTML_Element</li>
      <li>LogicalDocument</li>
      <li>HLDocProfile</li>
      <li>ComplexAttr</li>
      <li>CssPropertyItem</li>
    </ul>
  </li>
  <li>
    Helper classes
    <ul>
      <li>DataSrcElm</li>
      <li>HEListElm</li>
      <li>ImageAnimationHandler</li>
      <li>LinkElement</li>
      <li>OpElementInfo</li>
      <li>UrlImageContentProvider</li>
      <li>NamespaceManager</li>
      <li>OpElementCallback</li>
      <li>OpTreeCallback</li>
    </ul>
  </li>
  <li>
    Saving files
    <ul>
      <li>SaveWithInlineHelper</li>
      <li>SaveAsArchiveHelper</li>
    </ul>
  </li>
  <li>
    Support files for different markup types
    <ul>
      <li>HTM_Lex</li>
      <li>WML_Lex</li>
      <li>OMF_Lex</li>
      <li>XML_Lex</li>
      <li>XV_Lex</li>
      <li>VXML_Lex</li>
      <li>WBXML_Parser</li>
      <li>WBXML_Decoder</li>
    </ul>
  </li>
</ul>
</div>

<div class="section">
<h2>API Details (Doxygen)</h2>

<a href="api/index.html">API details generated by Doxygen here</a>
</div>

<div class="section">
<h2>Memory usage documentation</h2>

<h3>Used OOM policies</h3>

<p>The logdoc module uses three different OOM strategies, OP_STATUS, TRAP/LEAVE and flagging.</p>

<p>The most common strategy used is the OP_STATUS method. Most functions that allocate memory return an OP_STATUS to indicate wether it was successful or not. That is the preferred choice.<br/>
Some functions rely on functions from other modules that uses the TRAP/LEAVE mechanism. In those cases it is sometimes easier to let the method leave instead of using OP_STATUS. Try to avoid that to cases where you have a single point to TRAP the LEAVEs.<br/>
During parsing the logdoc module uses the a flag in HLDocProfile that can be set if we run out of memory in an operation during parsing. When the parsing pass is finished we will check the flag and signal OOM error. This is used so that we don't have to check the return value for every function call and to make it easier to continue parsing as long as possible after having trouble allocating (potentially) large blocks of memory.</p>

<h3>Who is handling OOM</h3>

<p>The only handling of a OOM case in this module is to signal that we have one. There are no active attempts to recover except for not crashing.</p>

<h3>Description of flow</h3>

<p>The logical tree is contained in a logical document. The logical document is responsible for freeing up the memory used for the logical tree. In cases where there are ECMAScript references to any element in the tree ECMAScript takes over the responsibility of making sure the element is freed.</p>

<h3>Heap memory usage</h3>

<p>All elements in the logical tree are allocated on the head. There is roughly one element in the tree per element in the source document.<br/>
The logical document that holds the tree is also allocated on the heap. It is one per document and frame.</p>

<h3>Stack memory usage</h3>

<p>The conventional HTML-parser is recursive and the Load() method will call itself after encountering a start tag to parse the content. It will recurse as deep as the number of unclosed open tags in the document. For some malformed documents that can be quite a deep structure and the recursive calls will fill up the stack and Opera will crash.<br/>
To fix that problem we will probably at some point rewrite the parser to be iterative instead of recursive. A quick solution is to use the <tt>MAX_TREE_DEPTH</tt> constant to set the maximum nesting level for the Load() method.</p>

<h3>Static memory usage</h3>

<p>All global variables are moved to the LogdocModule object. Initialization of const arrays of strings are specially handled for the platforms that doesn't support complex globals.<br/>
Logdoc uses quite a few lookup tables for mapping element and attribute names to numeric constants and back. As mentioned above the string tables are initialized in the InitializeL() method of LogdocModule.</p>

<h3>Caching and freeing memory</h3>

<p>The logical document and the tree is freed from the FramesDocument it belongs to so when the document is cleared from the document cache the logical document is cleared as well.<br/>
There are no local caching mechanisms.</p>

<h3>Freeing memory on exit</h3>

<p>The memory that is allocated in the LogdocModule object at startup is freed on exit.<br/>
All memory allocated to logical documents or trees are either deleted when the FramesDocument is or when the ECMAScript objects referencing them are deleted.</p>

<h3>Temp buffers</h3>

<p>The shared temp buffers in the MemoryManager are used extensively throughout the logdoc module. There are no real
checks to assure that they are not used by someone else. The use of those temp buffers is not encouraged and code that
uses them should be rewritten.</p>

<h3>Memory tuning</h3>

<p>There is no real memory tuning.</p>

<h3>Tests</h3>

<p>None</p>

<h3>Design choices</h3>

<p>In earlier versions we used to allocate all data used by the logical document by using our own memory allocation mechanism that used large preallocated blocks. These blocks would live as long as the document and would be deleted when the document was thrown out.<br/>
When we started to allow pages to modify the tree using script and other mechanisms we realized that that could cause higher memory usage since nothing was deleted until the document was deleted and changes would just allocate more memory without freeing. We then switched to normal new/delete allocation of all data used in the logical document.</p>

<h3>Suggestions of improvements</h3>

<p>Some changes that should be done:</p>

<ul>
<li>Stop using the preallocated temp buffers in MemoryManager</li>
</ul>

<h3>[footprint] Store string constants as single-byte</h3>
<p>A lot of the constant strings used in the module is stored as Unicode strings requiring 2 bytes for every character. Most of them could probably be stored as single-byte characters.</p>
</div>

<div class="section">
<h2>Design Issues</h2>
</div>

<div class="section">
<h2>Special topics</h2>

<ul>
  <li><a href="special_attrs.html">Special internal attributes</a></li>
  <li><a href="namespaces.html">Element types and namespace</a></li>
  <li><a href="pictogram.html">Pictograms</a></li>
</ul>
</div>

<h2>Appendix</h2>

<div class="section">
<h2>Scripts</h2>

<h3>Character entitities</h3>

<p>The script <a href="../scripts/entities.pl"><tt>entities.pl</tt></a> is used
to generate the list of character entities supported by Opera. It uses a list
extracted from the HTML 4.01 specification, stored in the file
<a href="../scripts/entities.txt"><tt>entities.txt</tt></a>, plus a few extras
and compatibility aliases listed in the script itself to generate the list in
the file <a href="../src/entities.inl"><tt>entities.inl</tt></a>.</p>

<h3>Named colors</h3>

<p>The script <a href="../scripts/mkcolornames.pl"><tt>mkcolornames.pl</tt></a>
is used to generate the list of named colors supported by Opera. It uses a list
of RGB values, stored in the file
<a href="../scripts/colors.hex"><tt>colors.hex</tt></a>, to generate the list in
the file <a href="../html_col.h"><tt>html_col.h</tt></a>.</p>

<h3>Supported tags and attributes</h3>

<p>The scripts <a href="../scripts/mktags_html.pl"><tt>mktags_html.pl</tt></a>,
<a href="../scripts/mktags_omf.pl"><tt>mktags_omf.pl</tt></a>,
<a href="../scripts/mktags_svg.pl"><tt>mktags_svg.pl</tt></a> and
<a href="../scripts/mktags_wml.pl"><tt>mktags_wml.pl</tt></a>
are used to generate the lists of tags and attributes  supported by Opera. They
use lists of strings, stored in the files
<a href="../scripts/tags_html.txt"><tt>tags_html.txt</tt></a>, 
<a href="../scripts/tags_omf.txt"><tt>tags_omf.txt</tt></a>, 
<a href="../scripts/tags_svg.txt"><tt>tags_svg.txt</tt></a> and
<a href="../scripts/tags_wml.txt"><tt>tags_wml.txt</tt></a>, 
to generate the lists in the files specified in the script.</p>

</div>

</body>
</html>
