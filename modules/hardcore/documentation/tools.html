<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
          "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <link rel=stylesheet href="../../coredoc/coredoc.css" />
  <title>Documentation about hardcore tools</title>
  <style type="text/css">
    pre { border-left: 2px solid #ddd; }
  </style>
</head>
<body>

<h1>Documentation about hardcore tools</h1>

<ul>
<li><a href="#update_vcproj.py">update_vcproj.py</a>
  <ul>
    <li><a href="#update_vcproj.py-project_file">The expected project file structure</a></li>
    <li><a href="#update_vcproj.py-options">Command line options</a></li>
    <li><a href="#update_vcproj.py-example">Example wingogi</a></li>
  </ul>
</li>
<li><a href="#References">References</a></li>
</ul>

<a name="update_vcproj.py">
<h2>update_vcproj.py</h2>

The script <code>update_vcproj.py</code> reads
the <a href="sources.html">sources setup</a> which is generated by the
<a href="operasetup.html">operasetup</a> script and updates the source
file entries in a Visual Studio 2005 or 2008 project file according to
the source's configuration.

<a name="update_vcproj.py-project_file">
<h3>The expected project file structure</h3>

The script can handle Visual Studio 2005 or 2008 project files. The
project file is stored as an xml file. The xml file has several
sections:
<ul>
<li>A <code>&lt;Configurations&gt;</code> section which contains all
  available configurations for the project. The configurations of this
  section are parsed and if a single file is updated with an
  individual configuration, a <code>&lt;FileConfiguration&gt;</code>
  section is added for all found configurations.
<li>A <code>&lt;Files&gt;</code> section, which contains all source
  files. The files are organized in "Filter" entries.</li>
</ul>

The script expects the project file to have the following structure:
<ul>
  <li>The <code>&lt;Files&gt;</code> node should have a
    top-level <code>&lt;Filter&gt;</code> node with name "<code>Source
      Files</code>". If that filter is not available, the scripts
    fails with an error message.<p /></li>

  <li>All <code>&lt;Configurations&gt;</code> are expected to
    use <code>"core/pch.h"</code> as precompiled header
    file. I.e. all configurations should set the attributes<br />
    <table>
      <tr>
        <th>UsePrecompiledHeader</th>
        <td>"<em>Use Precompiled Header File</em>"<br />
          (this corresponds to the compiler command line argument
          "<code>/Yu</code>" or the xml attribute value
          "<code>2</code>").</td>
      </tr>
      <tr>
        <th>PrecompiledHeaderThrough</th>
        <td><code>"core/pch.h"</code></tr>
      <tr>
        <th>PrecompiledHeaderFile</th>
        <td>should specify in which file the precompiled header file
          is stored. <code>wingogi</code> uses the following value:
          <code>"$(IntDir)/wingogi/wingogi.pch"</code>.</td>
      </tr>
    </table>
    Any <code>#include "core/pch.h"</code> statement is then processed
    by including the precompiled header file.</td>
  </li>

  <li>There should be one source-file in the project which generates
    the precompiled header file. The source-file usually only includes
    the header file:
<pre>
#include "core/pch.h"
</pre>
    and is configured as
    <table>
      <tr>
        <th>UsePrecompiledHeader</th>
        <td>"<em>Create Precompiled Header File</em>"<br />
          (this corresponds to the compiler command line argument
          "<code>/Yc</code>" or the xml attribute value
          "<code>1</code>").</td>
      </tr>
    </table>
    That source-file should receive the
    option <a href="sources.html#option-jumbo">no-jumbo</a> in the
    corresponding <code>module.sources</code> file.<p /></li>

  <li><a name="node-create-pch_jumbo" />Optionally the project file may
    have additional source-files which generate precompiled header
    files for <code>"core/pch_jumbo.h"</code>
    and <code>core/pch_system_includes.h</code>. For each precompiled
    header file a source-file is needed that includes the header
    file. The source-file should be configured like
    <table>
      <tr>
        <th>UsePrecompiledHeader</th>
        <td>"<em>Create Precompiled Header File</em>"<br />
          (this corresponds to the compiler command line argument
          "<code>/Yc</code>" or the xml attribute value
          "<code>1</code>").</td>
      </tr>
      <tr>
        <th>PrecompiledHeaderThrough</th>
        <td><code>"core/pch_jumbo.h"</code>
          respectively <code>"core/pch_system_includes.h"</code></td>
      </tr>
      <tr>
        <th>PrecompiledHeaderFile</th>
        <td>should specify in which file the precompiled header file
          is stored. <code>wingogi</code> uses the following value
          for <code>"core/pch_jumbo.h"</code>:
          <code>"$(IntDir)/wingogi/wingogi_jumbo.pch"</code>.</td>
      </tr>
    </table>
    The corresponding source-file should receive the
    option <a href="sources.html#option-jumbo">no-jumbo</a> in the
    corresponding <code>module.sources</code> file.<p /></li>
</ul>

<p>
  The script recognizes source-file entries with "<em>Create
    Precompiled Header File</em>" option
    for <code>"core/pch_jumbo.h"</code>
  and <code>"core/pch_system_includes.h"</code> and uses the
  corresponding <code>PrecompiledHeaderThrough</code>
  and <code>PrecompiledHeaderFile</code> settings to update the
  file-configuration for <a href="sources.html#option-jumbo">jumbo
    compile units</a> or source files with option
  <a href="sources.html#option-system_includes">system_includes</a>.
</p>

The script updates the structure of the "<code>Source Files</code>"
filter node in the following way:
<ul>
  <li>Each sub-directory of the source-root is represented as
    a <code>&lt;Filter&gt;</code> node with the name of the
    sub-directory. The parent node of a filter is the filter node of
    the parent directory. The parent node of the top-level directories
    (like <code>modules/</code> or <code>platforms/</code>) is the
    filter with name "<code>Source Files</code>".<br />
    E.g. there is a filter with name "<code>modules</code>" as a
    direct child of the filter "<code>Source Files</code>" and all
    sub-directories in <code>modules/</code> are represented by
    children of that node.<br />
    If the filter node of any of the subdirectories is not available,
    the filter is inserted.<p /></li>

  <li>Each source-file is represented as a <code>&lt;File&gt;</code>
    node with a "<code>RelativePath</code>" relative to the location
    of the project file. The file node is child of the
    <code>&lt;Filter&gt;</code> node which represents the file's
    directory.<br />
    If the file node is not available, it is created. If there is a
    file node which does not belong to any file of the
    <a href="sources.html#Sources_Setup">Sources Setup</a>, the file
    node is removed.<p /></li>

  <li>If a precompiled header file is configured for
    <code>"core/pch_system_incudes.h"</code>, then a source-file with
    option <a href="sources.html#option-pch">pch</a> and
    <a href="sources.html#option-system_includes">system_includes</a>
    receives the configuration
    <table>
      <tr>
        <th>UsePrecompiledHeader</th>
        <td>"<em>Use Precompiled Header File</em>"<br >
          (this corresponds to the compiler command line argument
          "<code>/Yu</code>" or the xml attribute value
          "<code>2</code>").</td>
      </tr>
      <tr>
        <th>PrecompiledHeaderThrough</th>
        <td><code>"core/pch_system_includes.h"</code></td>
      </tr>
      <tr>
        <th>PrecompiledHeaderFile</th>
        <td>As configured for the corresponding "<em>Create
            Precompiled Header File</em>" node.</td>
      </tr>
    </table>
    If no precompiled header file is configured
    for <code>"core/pch_system_incudes.h"</code>, then a source-file
    with option <a href="sources.html#option-pch">pch</a> and
    <a href="sources.html#option-system_includes">system_includes</a>
    is configured to not use a precompiled header file.<p /></li>

  <li>If a precompiled header file is configured for
    <code>"core/pch_jumbo.h"</code>, then a jumbo-compile-unit with
    option <a href="sources.html#option-pch">pch</a> receives the
    configuration
    <table>
      <tr>
        <th>UsePrecompiledHeader</th>
        <td>"<em>Use Precompiled Header File</em>"<br />
          (this corresponds to the compiler command line argument
          "<code>/Yu</code>" or the xml attribute value
          "<code>2</code>").</td>
      </tr>
      <tr>
        <th>PrecompiledHeaderThrough</th>
        <td><code>"core/pch_jumbo.h"</td>
      </tr>
      <tr>
        <th>PrecompiledHeaderFile</th>
        <td>As configured for the corresponding "<em>Create
            Precompiled Header File</em>" node.</td>
      </tr>
    </table>
    If no precompiled header file is configured
    for <code>"core/pch_jumbo.h"</code>, then the jumbo-compile-unit
    is configured to not use a precompiled header file.<p /></li>
</ul>

<p>
  <em>Note:</em> Instead of adding a source-file with option
  "<em>Create Precompiled Header File</em>" for
  <code>"core/pch_jumbo.h"</code>
  (<a href="#node-create-pch_jumbo">see above</a>) you can use the
  command line
  option <a href="#pch_jumbo"><code>--pch_jumbo</code></a>.
</p>
</a> <!-- update_vcproj.py-project_file -->


<a name="update_vcproj.py-options">
<h3>Command line options</h3>

<p>
Usage:
<pre>
update_vcproj.py [options] [project_file]
</pre>
<dl>
<dt class="option">[project_file]</dt>
<dd>
  should be a Visual Studio 2005 or 2008 project file. If no project
  file is specified, the file <code>wingogi.vcproj</code> is used.
</dd>
</dl>

The commandline options are:
<dl>
<dt class="options"><a name="template">--template=TEMPLATE_FILE</a></dt>
<dd>
  generate the project-file from the specifed template filename. Instead of
  parsing the project file, updating the xml structure and writing the output,
  a simple template file can be used. The template file needs to contain only
  the configuration, and the source-files that are needed to generate the
  precompiled header files. Using a template speeds up the parsing and helps
  to silence git when the project file has changed.
  See also <a href="#update_vcproj.py-project_file">The expected project file structure</a>.
</dd>

<dt class="options">--exclude_module <em>branch/module</em></dt>
<dt class="options">--exclude_module=<em>branch/module</em></dt>
<dd>
  Removes the source files of the specified module from the project
  file. Usually all sources files of all modules are included in the
  project file. By using this option some modules can be
  excluded. E.g. wingogi builds call this script with arguments like:
<pre>
  --exclude_module platforms/lingogi
</pre>
</dd>

<dt class="options">--include_module <em>branch/module</em></dt>
<dt class="options">--include_module=<em>branch/module</em></dt>
<dd>
  Includes only the source files of the specified modules in the
  project file. Usually all sources files of all modules are included
  in the project file. By using this option all but the specified
  modules are excluded.
</dd>

<dt class="options">--force_update</dt>
<dd>
  To skip the dependency check. Usually the project file is only
  parsed and updated if any of the
  <a href="sources.html#Sources_Setup">source.*</a> files that are
  created by <a href="operasetup.html">operasetup.py</a> are newer
  than the project file. This saves a lot of time on parsing the
  project file.

  <p>
    <em>Note:</em> even if force_update is specified, the project file
    might not be written, because its content might not have changed.
  </p>
</dd>

<dt class="options">--jumbo</dt>
<dd>
  To enable compiling with <a href="sources.html#option-jumbo">jumbo
    compile</a> units. All module source files which are included in a
  jumbo compile unit are kept in the project file, but they are
  excluded from the build process.

  <p>
    To remove the excluded files, use the
    argument <code>--remove_excluded_files</code>.
  </p>

  <p>
    <em>Note:</em> the jumbo-compile-units are generated
    by <a href="operasetup.html">operasetup.py</a>. This script only
    enables or disables the jumbo compile units. To disable jumbo
    compilation, don't use the <code>--jumbo</code> argument.
  </p>
</dd>

<dt class="options">--remove_excluded_files</dt>
<dd>
  To remove all files from the project file, that are excluded from
  the build. By default both the jumbo compile units and the plain
  files are added to the project file and the files that are not used
  are marked with the attribute <code>ExcludedFromBuild</code>. This
  allows to use a jumbo compilation and still keep fast access to all
  source files, but the project file will grow very big and updating
  it takes much more time. With this option, only the files that are
  required for the build are added to the project file, i.e. for a
  jumbo-build only the jumbo compile units are added to the project
  file and for a plain-build only the plain sources are added to the
  project file. This keeps the project file small and thus it can also
  be updated fast.
</dd>

<dt class="options">--keep_excluded_files</dt>
<dd>
  Is the opposite to option <code>--remove_excluded_files</code>. Both
  the jumbo compile units and the plain files are added to the project
  file and the files that are not used are marked with the
  attribute <code>ExcludedFromBuild</code>. This is the default
  setting.
</dd>

<dt class="options"><a name="pch_jumbo">--pch_jumbo=FILENAME</a></dt>
<dd>
  Specifies the pch file which is the precompiled header file that was
  generated for the <code>#include "core/pch_jumbo.h"</code>
  statement. If this argument is not specified, this script parses the
  specifed project file for an entry with
  configuration <code>UsePrecompiledHeader=1</code>
  and <code>PrecompiledHeaderThrough=core/pch_jumbo.h</code>,
  i.e. create a precompiled header file
  for <code>"core/pch_jumbo.h"</code>. The filename is used for
  the <code>PrecompiledHeaderFile</code> attribute in the project
  file.
</dd>

<dt class="options"><a name="sources_filter">--sources_filter=NAME</a></dt>
<dd>
  add the source files to the filter with the specified name. The default
  filter name is "<tt>Source Files</tt>". If an empty string is specifed,
  the source files are added directly to project;
  eg: <tt>--sources_filter=</tt>.
</dd>

<dt class="options"><a name="no-error_on_update">--no-error_on_update</a></dt>
<dd>
  Don't exit with an error-code when the project file was updated. The default
  is to exit with an error code; thus Visual Studio stops compilation and has
  time to reload the project file before compilation continues.
</dd>

<dt class="options">--quiet</dt>
<dt class="options">--no-quiet</dt>
<dd>Print some debug messages about the progress.</dd>
</dl>
</a> <!-- update_vcproj.py-options -->

<a name="update_vcproj.py-example">
<h3>Example wingogi</h3>

<p>
  The wingogi project has two source-files which are used to generate
  precompiled header files:
<ul>
  <li><code>platforms/wingogi/pch.cpp</code>:
<pre>
/* <em>... some copyright header ...</em> */
#include "core/pch.h"
</pre></li>
  <li><code>platforms/wingogi/pch_jumbo.cpp</code>:
<pre>
/* <em>... some copyright header ...</em> */
#include "core/pch_jumbo.h"
</pre></li>
</ul>
</p>

<p>
  The corresponding <code>platforms/wingogi/module.sources</code> file
  contains entries for both files with
  option <a href="sources.html#option-jumbo">no-jumbo</a>:
<pre>
pch.cpp # [<a href="sources.html#option-jumbo">no-jumbo</a>]
pch_jumbo.cpp # [<a href="sources.html#option-jumbo">no-jumbo</a>]
...
</pre>
</p>

<p>
  The visual studio project file configures the default precompiled
  header settings as (i.e. these setting are configured inside
  the <code>&lt;Configurations&gt;</code> node of the project file):
  <table>
    <tr>
      <th>UsePrecompiledHeader</th>
      <td>"<em>Use Precompiled Header File</em>"<br />
        (this corresponds to the compiler command line argument
        "<code>/Yu</code>" or the xml attribute value
        "<code>2</code>").</td>
    </tr>
    <tr>
      <th>PrecompiledHeaderThrough</th>
      <td><code>"core/pch.h"</code></td>
    </tr>
    <tr>
      <th>PrecompiledHeaderFile</th>
      <td><code>"$(IntDir)/wingogi/wingogi.pch"</code></td>
    </tr>
  </table>
</p>

<p>
  The precompiled header configuration of the
  source-file <code>platforms/wingogi/pch.cpp</code> (i.e. in
  the <code>&lt;FileConfiguration&gt;</code> node of
  the <code>&lt;File&gt;</code>) is
  <table>
    <tr>
      <th>UsePrecompiledHeader</th>
      <td>"<em>Create Precompiled Header File</em>"<br />
        (this corresponds to the compiler command line argument
        "<code>/Yc</code>" or the xml attribute value
        "<code>1</code>").</td>
    </tr>
  </table>
  <em>Note:</em> the other setting <code>PrecompiledHeaderFile</code>
  and <code>PrecompiledHeaderThrough</code> are obtained through the
  default configuration.
</p>

<p>
  The precompiled header configuration of the
  source-file <code>platforms/wingogi/pch_jumbo.cpp</code> (i.e. in
  the <code>&lt;FileConfiguration&gt;</code> node of
  the <code>&lt;File&gt;</code>) is
  <table>
    <tr>
      <th>UsePrecompiledHeader</th>
      <td>"<em>Create Precompiled Header File</em>"<br />
        (this corresponds to the compiler command line argument
        "<code>/Yc</code>" or the xml attribute value
        "<code>1</code>").</td>
    </tr>
    <tr>
      <th>PrecompiledHeaderThrough</th>
      <td><code>"core/pch_jumbo.h"</code></td>
    </tr>
    <tr>
      <th>PrecompiledHeaderFile</th>
      <td><code>"$(IntDir)/wingogi/wingogi_jumbo.pch"</code></td>
    </tr>
  </table>
</p>

<p>
  The wingogi solution file has a "sources" project which calls
  the <code>update_vcproj.py</code> as
<pre>
.\modules\hardcore\tools\update_vcproj.py --jumbo \
    --exclude_module=platforms/lingogi \
    --template=platforms\wingogi\build\wingogi_vc2008.vcproj.template platforms\wingogi\build\wingogi_vc2008.vcproj
</pre>
</p>

</a> <!-- update_vcproj.py-example -->


</a> <!-- update_vcproj.py -->

<a name="References">
<h2>References</h2>
<ul>
<li><a name="vs-pch">[1] MSDN: MSDN Library: Development Tools and
    Languages: Visual Studio 2008: Visual Studio: Visual C++: Building
    a C/C++ Program: C/C++ Building Reference: Compiling a C/C++
    Program: <em>"Creating Precompiled Header Files"</em>
    <a target="new" href="http://msdn.microsoft.com/en-us/library/szfdksca.aspx">http://msdn.microsoft.com/en-us/library/szfdksca.aspx</a></li>
</ul>
</a>
</p>
</body>
</html>
