
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=ASMO-708" />
<META keywords="UPnP, NAT Traversal, Alien, Opera Unite" author="Luca venturi" />
<link href="report.css" type="text/css" rel="stylesheet" />
<title>Opera Unite - NAT Traversal Stategies
</title>
</head>
	<body>
		<div style="width:7.763888888888889in">
			<table class="CoverPageBorder">
				<tr>
					<td class="CoverPageTopBorderToReportTitleSpan">
					</td>
				</tr>
				<tr>
					<td style="text-align:center"><span class="CoverPageReportTitleText">Opera Unite - NAT Traversal Stategies<br />
<br />
EARLY DRAFT<br />
<br />
<br />
<i>These are possible scenarios, not necessarily planned implementations</i></span>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="CoverPageReportTitleUnderline">
							</div>
						</center>
					</td>
				</tr>
				<tr>
					<td class="CoverPageReportTitleToOrganizationNameSpan">
					</td>
				</tr>
				<tr>
					<td style="text-align:center"><span class="CoverPageOrganizationNameText">Opera Software ASA</span>
					</td>
				</tr>
				<tr>
					<td style="text-align:center"><span class="CoverPageAuthorText">Luca Venturi</span>
					</td>
				</tr>
				<tr>
					<td class="CoverPageEndingSpan">
					</td>
				</tr>
			</table>
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table class="TOCTOFBorder">
				<tr>
					<td><span class="Heading1">Table of Contents</span>
						<ul>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#wsYnLxiAUFAwUANQ" class="ItemLink"><span>Common Opera Unite P2P Session</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#M7UicJiGAqACZQZj" class="ItemLink"><span>1 - Directly connected to Internet</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#FZdKcJiGAqACZUG2" class="ItemLink"><span>2 - UPnP Enabled IGD Case</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#_2M68JiGAqAAxwso" class="ItemLink"><span>3 - UDP Full Cone NAT - Opera Only</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#JamsdJiGAqAAxgSu" class="ItemLink"><span>4 - UDP Restricted Cone NAT - Opera Only</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#Bwt6dJiGAqAAxnbP" class="ItemLink"><span>5 - Symmetric NAT (Opera Only) or UPnP Disabled</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#2OzOdJiGAqAAxsEH" class="ItemLink"><span>6 - Local Proxy</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#H.sRdJiGAqAAxidT" class="ItemLink"><span>7 - Reverse Connection</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#KxzXTJiGAqAAxquY" class="ItemLink"><span>8 - Services Discovery on Intranet</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#xvBTTJiGAqAAxmRo" class="ItemLink"><span>Corner Case A: serial IGD devices</span>
								</a>
							</li>
							<li>
								<img src="images/CommunicationDiagram.jpg" />
								<a href="#i2oHTJiGAqAAxpEY" class="ItemLink"><span>Corner Case B: parallel IGD devices</span>
								</a>
							</li>
							<li>
								<img src="images/InteractionDiagram.jpg" />
								<a href="#R4u0A.iGAqACZAO7" class="ItemLink"><span>UPnP Discovery Process</span>
								</a>
							</li>
							<li>
								<img src="images/InteractionDiagram.jpg" />
								<a href="#_UEuA.iGAqACZDJU" class="ItemLink"><span>UPnP Port Opening Process</span>
								</a>
							</li>
							<li>
								<img src="images/StateDiagram.jpg" />
								<a href="#2o7oFRiGAqACZjQS" class="ItemLink"><span>UPnP Network Changes Discovery</span>
								</a>
							</li>
							<li>
								<img src="images/StateDiagram.jpg" />
								<a href="#I1a2.hiGAqAAxi8P" class="ItemLink"><span>NAT traversal strategy</span>
								</a>
							</li>
						</ul>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="wsYnLxiAUFAwUANQ" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">Common Opera Unite P2P Session</span>
			<br />
			<img class="Image" src="images/Common_Opera_Unite_P2P_Session.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">Generic abstraction of an 
      Opera Unite session. The server is a Opera Unite Server, the client 
      could be any browser. </font>
    </p>
    <p>
      There will be different scenarios, depending on the presence of network 
      devices, and on the client browser.
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="M7UicJiGAqACZQZj" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">1 - Directly connected to Internet</span>
			<br />
			<img class="Image" src="images/1_Directly_connected_to_Internet.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this scenario, the 
      server is not behind a NAT device, so it appears to be directly 
      connected to Internet.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="FZdKcJiGAqACZUG2" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">2 - UPnP Enabled IGD Case</span>
			<br />
			<img class="Image" src="images/2_UPnP_Enabled_IGD_Case.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">This is the typical home 
      scenario, where the server is behind a UPnP enabled device, like an ADSL 
      router.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="_2M68JiGAqAAxwso" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">3 - UDP Full Cone NAT - Opera Only</span>
			<br />
			<img class="Image" src="images/3_UDP_Full_Cone_NAT_Opera_Only.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this case, the server is 
      behind a Full Cone NAT, which is the easiest NAT case. </font>
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">It is not supposed to be a 
      very common situation. </font>
    </p>
    <p>
      
<br>      <font face="Dialog" size="3" color="#000000">The client needs to be 
      an Opera Unite browser.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="JamsdJiGAqAAxgSu" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">4 - UDP Restricted Cone NAT - Opera Only</span>
			<br />
			<img class="Image" src="images/4_UDP_Restricted_Cone_NAT_Opera_Only.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this scenario, the user 
      is behind a "Restricted Cone" or a "Port Restricted Cone" NAT. </font>
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">It should be a common 
      situation for home users with the UPnP protocol disabled. </font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">The client needs to be a 
      Opera Unite enabled browser.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="Bwt6dJiGAqAAxnbP" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">5 - Symmetric NAT (Opera Only) or UPnP Disabled</span>
			<br />
			<img class="Image" src="images/5_Symmetric_NAT_Opera_Only_or_UPnP_Disabled.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">This is the only way that 
      basically works in any situation where the Client and the Server are 
      connected to the Internet.</font>
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">The problem is the 
      bandwidth consumption and the load on the Opera Server. Latency too can 
      have a little impact. </font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">At the beginning, it would 
      be the only way to handle a Symmetric NAT (very common in Enterprises), 
      but if required we could manage some special cases without the proxy. We 
      could even try some "port guessing", and sometimes succeed to connect 
      without the proxy. </font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="2OzOdJiGAqAAxsEH" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">6 - Local Proxy</span>
			<br />
			<img class="Image" src="images/6_Local_Proxy.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this scenario, we 
      basically transform a "non Opera Unite" browser in an "Opera Unite 
      Enabled" browser. This can be done thanks to an applet deployed in the 
      Client with the help of the Opera DNS. </font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="dialog" size="3" color="#000000">Similar results (probably 
      with a better success ratio, but at a higher cost and slower 
      time-to-market) can be achieved, writing a plug-in for every browser 
      that we want to support.</font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="dialog" size="3" color="#000000">This scenario is only 
      hypothetical, there are no plans to implement it.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="H.sRdJiGAqAAxidT" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">7 - Reverse Connection</span>
			<br />
			<img class="Image" src="images/7_Reverse_Connection.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this case, the Server is 
      behind a Symmetric NAT, but the client is able to receive incoming 
      connections, so the Server can start the Opera Unite Session, and we can 
      avoid to use the proxy</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="KxzXTJiGAqAAxquY" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">8 - Services Discovery on Intranet</span>
			<br />
			<img class="Image" src="images/8_Services_Discovery_on_Intranet.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this scenario the Client 
      and the Server could even not be connected to the Internet, but they are 
      on the same Intranet (with UDP broadcast enabled), so they can use UPnP 
      services discovery to communicate. </font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="dialog" size="3" color="#000000">There are several security 
      concerns that needs to be addressed.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="xvBTTJiGAqAAxmRo" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">Corner Case A: serial IGD devices</span>
			<br />
			<img class="Image" src="images/Corner_Case_A_serial_IGD_devices.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this corner case, 
      hopefully not so common, we will have a chain of several IGD devices; 
      internal tests have shown that with UPnP we probably will be able to 
      open a port only in the first UPnP router, so we will need to use UDP 
      hole punching or the proxy to allow Opera Unite Sessions. </font>
    </p>
    <p>
      
    </p>
    <p>
      <font face="dialog" size="3" color="#000000">Theoretically UPnP "should" 
      allow opening a port in this situation, (according to the 
      specifications, IGMP Join messages are required on non-AutoIP addresses, 
      like DHCP ones) but at the moment it is not so clear if it is really 
      useful to try to support this configuration.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="i2oHTJiGAqAAxpEY" /><span class="DiagramType">Communication Diagram</span>
			<br /><span class="Heading1">Corner Case B: parallel IGD devices</span>
			<br />
			<img class="Image" src="images/Corner_Case_B_parallel_IGD_devices.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">In this case, we have 
      several UPnP devices, probably connected to different networks. We will 
      try to open a port on every device detected.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="R4u0A.iGAqACZAO7" /><span class="DiagramType">Sequence Diagram</span>
			<br /><span class="Heading1">UPnP Discovery Process</span>
			<br />
			<img class="Image" src="images/UPnP_Discovery_Process.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">This is the algorithm used 
      during the UPnP Discovery phase, when the server tries to find a UPnP 
      enabled IGD device</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="_UEuA.iGAqACZDJU" /><span class="DiagramType">Sequence Diagram</span>
			<br /><span class="Heading1">UPnP Port Opening Process</span>
			<br />
			<img class="Image" src="images/UPnP_Port_Opening_Process.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">This is the algorithm used 
      to try to open a port in a UPnP enabled IGD device</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="2o7oFRiGAqACZjQS" /><span class="DiagramType">State Machine Diagram</span>
			<br /><span class="Heading1">UPnP Network Changes Discovery</span>
			<br />
			<img class="Image" src="images/UPnP_Network_Changes_Discovery.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">First implementation of the 
      UPnP port opening. Basically, we try to open a port in every router 
      detected, and when a change in the network configuration is detected. 
      Later we can try to support UPnP events notification too.</font>
    </p>
  </body>
</html>

			<p />
			<p />
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<table cellpadding="0" width="100%" cellspacing="0" border="0">
				<tr>
					<td>
						<center>
							<div class="SectionSeparator1" />
						</center>
					</td>
				</tr>
				<tr>
					<td>
						<center>
							<div class="SectionSeparator2" />
						</center>
					</td>
				</tr>
			</table>
			<table style="height:49px">
				<tr>
					<td>
					</td>
				</tr>
			</table>
			<a name="I1a2.hiGAqAAxi8P" /><span class="DiagramType">State Machine Diagram</span>
			<br /><span class="Heading1">NAT traversal strategy</span>
			<br />
			<img class="Image" src="images/NAT_traversal_strategy.png" />
			<p /><span class="Heading3">Documentation</span>
			<br /><html>
  <head>
    
  </head>
  <body>
    <p>
      <font face="Dialog" size="3" color="#000000">Proposal for the first 
      implementation of the NAT traversal Strategy of Opera Unite. </font>
    </p>
    <p>
      <font face="Dialog" size="3" color="#000000">The starting point is STUN, 
      but depending on what we will decide to support, it could be a lot more 
      complex.</font>
    </p>
  </body>
</html>

			<p />
			<p />
		</table>
	</body>
</html>