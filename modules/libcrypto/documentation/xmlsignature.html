<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
          "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
<link rel=stylesheet href="../../coredoc/coredoc.css" />
<title>Xml signing tutorial</title>
</head>
<body>
<H1> Xml signature Tutorials </H1>

<H2>Introduction</H2>

This document contains 3 tutorials 

<ol>
<li> Xml signing with certificate </li>
<li> Xml signing without certificate</li>
<li> Widget signing</li>
</ol>

An xml signature can be used to sign any file type.<br><br> 

We support a parts of the <a href="http://www.w3.org/TR/xmldsig-core/." > xml digital signature spec</a>. <br>
We support the (not finished) <a href="http://www.w3.org/TR/widgets-digsig/." > widget digital signature</a> spec.<br>
<br>
To sign files you need to following third party tools<br>
<ul>
	<li>Apache xml security:  download apache security source code from <a href="http://xml.apache.org/security/dist/c-library/">here</a>. We need the tool 'templatesign' from this package </li>
	<li>openssl, or any other tools capable to of generating PKI keys and certificates. In this tutorial we use openssl.</li>
</ul> 
<br>
<b>To verify the signatures, use the api in modules/libcrypto/include/CryptoXmlSignature.h</b>

<H2> XML signing tutorial (with certificate) </H2>

An xml signature bundled with a certificate is used when you want to protect the users from evil code generated by a third party.<br><br>
If you want to protect our code or config files from being tampered by the opera user, you should sign without a certificate, and instead hardcode the public key in memory (See tutorial below).
<H3>Create a private key</H3>

First generate a private_key which will be used to sign the files: 

<pre>openssl genrsa -des3 -out cakey.pem 4096</pre>

<H3>Create a self-signed CA certificate </H3>
openssl req -new -x509 -key cakey.pem -out cacert.pem<br>
<b>NOTE</b> Only do this for testing. In real life you should use one of the certificates allready installed in Opera.

<H3>Install cakey.pem in the browser.</H3> 
This can be done using desktop opera 9.5: <br>
Go to preferences->Advanced->Security->Manage Certificates->Authorities->Import.
<br>Choose *.pem type, in import cacert.pem<br><br>

To install the certificate into a mobile phone, copy ~/.opera/opcacrt6.dat from your desktop opera into the device.

<H3>Create a signer certificate</H3>

openssl genrsa -des3 -out privsignerkey.pem 4096<br> 
When prompted enter a *very* strong password<br><br>

Create a request for a certificate signed by CA:<br>
openssl req -new -key privsignerkey.pem -out certificate_request.csr<br><br>

Handle the request using the previous created CA certificate:<br>

openssl x509 -req -days 365 -in certificate_request.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 -out signercert.pem

<H3> Signing files </H3>
<H4> Template file </H4>
Save this file to signature_template.xml. Edit the file and create one reference element per file to be signed.
<pre>
&#60;?xml version="1.0" encoding="UTF-8"?&#62;
&#60;Signature xmlns="http://www.w3.org/2000/09/xmldsig#"&#62;
	&#60;SignedInfo&#62;
		&#60;CanonicalizationMethod
			Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/&#62;
		&#60;SignatureMethod
			Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1" /&#62;
		&#60;Reference URI="any_signed_file1.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;

		&#60;Reference URI="dir/any_signed_file2.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;

		&#60;Reference URI="dir/any_signed_file3.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;
	&#60;/SignedInfo&#62;
	&#60;SignatureValue&#62; &#60;/SignatureValue&#62;
&#60;/Signature&#62;
</pre>

<b> Important:</b> The spaces in the values of the &#60;DigestValue&#62; and &#60;SignatureValue&#62; tags are important. The templatesign tool will replace the spaces with the correct digests and signature. 
<br><br>
Save the file in a directory so that the relative paths given by &#60;Reference URI="some_path/some_file&#62; holds.
<H4> Signing </H4>

Sign with:<br>
templatesign -r private.pem &#60;The password given to openssl genrsa&#62;  -x signercert.pem signature_template.xml &#62; signature.xml<br><br>

templatesign comes from the apache xml security package.<br><br>

<b>signature_template.xml can now be discarded.</br></b>

<H4> Check signature </H4>
<pre>static OP_STATUS XmlSignature::VerifyXmlSignature(OpString &signer_id, VerifyError &reason, const uni_char *signed_files_base_path, const uni_char *signature_xml_file, BOOL ignore_certificate = FALSE, const unsigned char *public_key = 0, unsigned long key_len = 0);</pre>
with ignore_certificate = FALSE<br>


<H2> XML signing tutorial (without certificate) </H2>


You need the following addidational tools on linux<br>
<ul>
	<li>hexdump, --""--</li>
	<li>base64, --""--</li>
</ul>


If you want to protect our code or config files from being tampered by opera user, you should sign without certificate, and instead hard code the public key in memory.<br><br>


The reason is that the certificate system is not meant for protecting our files from the user. 
In this case the user can  install his own self signed CA certificate and then sign the config.
 

<H3>Create a private key</H3>
First generate a private_key which will be used to sign the files: 

<pre>openssl genrsa -des3 -out private.pem 4096</pre>

<H3> Generate the public key </H3>

<H4>Get the public key from private.pem:</H4>

<pre>openssl rsa -in private.pem -out public.pem -pubout</pre> 
<H4>Convert to binary</H4>

Edit public_pem, remove linebreaks and the first and last line (only keep the base64 encoded string).<br>
<br>
Next, convert the edited file to binary:<br>
<pre>base64 -d public.pem &#62; public.bin</pre>

<H4>Convert to a C char array</H4>
Generate a char array to put in source code. Use this to verify signed files.<br>
<pre>hexdump -e '8/1 "0x%02x, " "\n"'  public.bin &#62 public.hexdump </pre>

<H3> Signing files </H3>
<H4> Template file </H4>
Save this file to signature_template.xml. Edit the file and create one reference element per file to be signed.
<pre>
&#60;?xml version="1.0" encoding="UTF-8"?&#62;
&#60;Signature xmlns="http://www.w3.org/2000/09/xmldsig#"&#62;
	&#60;SignedInfo&#62;
		&#60;CanonicalizationMethod
			Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/&#62;
		&#60;SignatureMethod
			Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1" /&#62;
		&#60;Reference URI="any_signed_file1.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;

		&#60;Reference URI="dir/any_signed_file2.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;

		&#60;Reference URI="dir/any_signed_file3.extension"&#62;
			&#60;DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/&#62;
			&#60;DigestValue&#62; &#60;/DigestValue&#62;
		&#60;/Reference&#62;
	&#60;/SignedInfo&#62;
	&#60;SignatureValue&#62; &#60;/SignatureValue&#62;
&#60;/Signature&#62;
</pre>
<b> Important:</b> The spaces in the values of the &#60;DigestValue&#62; and &#60;SignatureValue&#62; tags are important. The templatesign tool will replace the spaces with the correct digests and signature. 
<br><br>

Save the file in a directory so that the relative paths given by &#60;Reference URI="some_path/some_file&#62; holds.
<H4>Signing</H4>
Sign with:<br>
templatesign -r private.pem &#60;The password given to openssl genrsa&#62;  signature_template.xml &#62; signature.xml<br><br>

templatesign comes from the apache xml security package.<br><br>

<b>signature_template.xml can now be discarded.</br></b>

<H4> Check signature </H4>
Use
<pre>static OP_STATUS XmlSignature::VerifyXmlSignature(OpString &signer_id, VerifyError &reason, const uni_char *signed_files_base_path, const uni_char *signature_xml_file, BOOL ignore_certificate = FALSE, const unsigned char *public_key = 0, unsigned long key_len = 0);</pre>
with 
ignore_certificate = TRUE,<br>
public_key = { the char array from public.hexdump }, <br>
key_len = the file size of public.bin (should be the same as the length of the char array public_key }


<H2> Widget signing tutorial </H2>

<H3>Needed tools</H3>
The signer bash script <a href="../scripts/signwidget.sh">modules/libcrypto/scripts/signwidget.sh</a> will only work in linux. It should be easy, however, to create a similar script in any other script language.<br><br> 

The signer script uses the tool "templatesign" from apache security to sign widgets. Download source code from <a href="http://xml.apache.org/security/dist/c-library/">here</a>.<br>
There is also a java version of the same library <a href="http://xml.apache.org/security/dist/"> here </a>.<br><br>
Follow the instructions given in this package to compile and install. Check that the tool 'templatesign' is installed in your
system.<br>

You also need to install openssl.

In addition we have made a simple bash script (modules/libcrypto/scripts/signwidget.sh) to simplify widget signing.


<H3>Create certificates</H3>

To sign widgets with a signature that verifies in all opera instances, you need to create two certificates. One CA certificate that is installed in 
all Opera instances, and one signer certificate that you use to sign the widgets. The signer certificate must be signed by the CA certificate.
 
<br><br> <b>Note that this tutorial is for testing only</b>. In real life the Certificate Authority should be Verisign or similar.
<H3>Create a certificate authority</H3>

<H4> Create a private key </H4>
First create a private key for the certificate authority (CA) :<br>
openssl genrsa -des3 -out cakey.pem 4096<br>
When prompted enter a *very* strong password<br><br>

<H4> Create a self-signed CA </H4>
Next, create a self-signed CA certificate: <br>
openssl req -new -x509 -key cakey.pem -out cacert.pem <br><br>

<H4> import the Ca cert into Opera  </H4>
Install cakey.pem in the browser. This can be done using desktop opera 9.5: <br>
Go to preferences->Advanced->Security->Manage Certificates->Authorities->Import.
<br>Choose *.pem type, in import cacert.pem<br><br>

To install the certificate into a mobile phone, copy ~/.opera/opcacrt6.dat from your desktop opera into the device.
<H3>Create a signer certificate</H3>

<H4> Create a private key </H4>
openssl genrsa -des3 -out privsignerkey.pem 4096<br> 
When prompted enter a *very* strong password

<H4> Create a public certificate </H4>
Create a request for a certificate signed by CA:<br>
openssl req -new -key privsignerkey.pem -out certificate_request.csr<br><br>

Handle the request using the previous created CA certificate:<br>

openssl x509 -req -days 365 -in certificate_request.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 -out signercert.pem



<H3>Signing a widget</H3>
Use the bash script given in modules/libcrypto/scripts/signwidget.sh<br><br>
<pre>signwidget.sh -r &#60;rsakey&#62; -p &#60;rsakey password&#62; -x &#60;x509cert&#62;  &#60;widgetpath&#62;</pre><br>

We can now a sign a widget using the signercert.pem create above:<br>
<pre>signwidget.sh -r privsignerkey.pem -p &#60;rsakey password&#62; -x signercert.pem &#60;widgetpath&#62;</pre>

Where &#60;rsakey password&#62 is the key you entered when creating privsignerkey.pem

</body></html>
